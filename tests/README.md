# Tests for osxphotos #

## Running Tests ##

To set up a dev environment to work on osxphotos code or run tests follow these steps.  This assumes you have python 3.7 or later installed.  If you need to install python, you can do so with the XCode command lines tools (`xcode-select --install`) or from [python.org](https://www.python.org/downloads/macos/).

- `git clone git@github.com:RhetTbull/osxphotos.git`
- `cd osxphotos`
- `python3 -m venv venv`
- `source venv/bin/activate`
- `python3 -m pip install -r dev_requirements.txt`
- `python3 -m pip install -e .`

To run the tests, do the following from the main source folder:
`python3 -m pytest tests/`

- To run a specific test specify its name with the -k flag: `python3 -m pytest -k "test_export_cleanup"`

## Skipped Tests ##

A few tests will look for certain environment variables to determine if they should run.

Some of the export tests rely on photos in my local library and will look for `OSXPHOTOS_TEST_EXPORT=1` to determine if they should run.

One test for locale does not run on GitHub's automated workflow and will look for `OSXPHOTOS_TEST_LOCALE=1` to determine if it should be run.  If you want to run this test, set the environment variable.

Some tests require GPU and will look for `OSXPHOTOS_TEST_CONVERT=1`. These will be skipped in GitHub Actions CI which doesn't provide a GPU.

A couple of tests require interaction with Photos and configuring a specific test library. Currently these run only on Catalina.  The tests must be specified by using a pytest flag. Only one of these interactive tests can be run at a time.  The current flags are:


- --addalbum: test --add-to-album options (pytest -vv tests/test_photosalbum_unicode.py tests/test_cli_add_to_album.py --addalbum)
- --timewarp: test `osxphotos timewarp` (pytest -vv --timewarp tests/test_cli_timewarp.py)
- --test-import: test `osxphotos import` (pytest -vv --test-import tests/test_cli_import.py)
- --test-sync: test `osxphotos sync` (pytest -vv --test-sync tests/test_cli_sync.py)
- --test-add-locations: test `osxphotos add-locations` (pytest -vv --test-add-locations tests/test_cli_add_locations.py)
- --test-batch-edit: test `osxphotos batch-edit` (pytest -vv --test-batch-edit -k batch)

## Test Photo Libraries

**Important**: The test code uses several test photo libraries created on various version of MacOS.  If you need to inspect one of these or modify one for a test, make a copy of the library (for example, copy it to your ~/Pictures folder) then open the copy in Photos.  Once done, copy the revised library back to the tests/ folder.  If you do not do this, the Photos background process photoanalysisd will forever try to process the library resulting in updates to the database which will cause git to see changes to the file you didn't intend.  I'm not aware of any way to disassociate photoanalysisd from the library once you've opened it in Photos.

Some of the "search_info" tests require data from my personal library on Catalina 10.15.7.  The data is generated by running `python3 tests/generate_search_info_test_data.py >tests/search_info_test_data_10_15_7.json`

## Test Data

There are some utilities in the `tests/` folder to generate test data for various tests.

- `tests/generate_sidecars_for_test.py`: generate sidecar files for testing. Needs to be run if code is modified that generates sidecar files.  This will generate sidecar files in the `tests/sidecars` folder.  The sidecar files are used by various tests.

- `tests/generate_search_info_test_data.py`: generate search_info test data. This is used only by the author to generate test data against my personal photo library.  This data is used by the search_info tests. Run as `python3 tests/generate_search_info_test_data.py >tests/search_info_test_data_10_15_7.json`

- `tests/gen_face_test_data.py`: generates face data used test_faceinfo.py

- The file `tests/iphoto_test_data.json` is used by `test_iphoto.py`.  It is generated by running `osxphotos query --json --library tests/Test-iPhoto-9.6.1.photolibrary/ > tests/iphoto_test_data.json`.
   - The file must then be edited to replace the full path to the library with `IPHOTO_LIBRARY_ROOT/Test-iPhoto-9.6.1.photolibrary` so that it can be used by the tests. This shouldn't be necessary unless changes are made to the test library.
   - Also, double check if any of the date fields need to be _restored back_ to previous values (example below) found on `tests/iphoto_test_data.json` so that tests pass.
```py
        "date": "2020-04-12T03:30:23+00:00",
        "date_added": "2023-09-27T06:43:07.850189+00:00",
        "date_modified": "2023-09-27T06:43:07.885464+00:00",
```

## Testing Face Regions

Here's my process for testing any code that manipulates face regions:

Export a test image with one or more face regions using:

`osxphotos export ~/Desktop/export --selected --exiftool`

Open the exported image in [XnViewMP](https://www.xnview.com/en/xnviewmp/#downloads).

In XnViewMP, select `View > Show people's region` to see the face regions. Verify the face regions are correct.

Then also test the sidecars. Re-export the image without `--exiftool` but use `--sidecar`:

`osxphotos export ~/Desktop/export --selected --sidecar xmp`

Apply the sidecar to the exported image using exiftool:

`exiftool -overwrite_original -tagsfromfile ~/Desktop/export/IMG_0001.xmp ~/Desktop/export/IMG_0001.jpg`

Re-open the image in XnViewMP and verify the face regions are correct.

Then also test the JSON and exiftool sidecars:

`osxphotos export ~/Desktop/export --selected --sidecar json`

`exiftool -overwrite_original -json=~/Desktop/export/IMG_0001.json ~/Desktop/export/IMG_0001.jpg`

Re-open the image in XnViewMP and verify the face regions are correct.

`osxphotos export ~/Desktop/export --selected --sidecar exiftool`

`exiftool -overwrite_original -json=~/Desktop/export/IMG_0001.json ~/Desktop/export/IMG_0001.jpg`

Re-open the image in XnViewMP and verify the face regions are correct.

## Attribution ##

These tests utilize a test Photos library. The test library is populated with photos from [flickr](https://www.flickr.com) and from my own photo library.  All images used are licensed under Creative Commons 2.0 Attribution [license](https://creativecommons.org/licenses/by/2.0/).

Flickr images used from:

- [Jeff Hitchcock](https://www.flickr.com/photos/arbron/48353451872/)
- [Carlos Montesdeoca](https://www.flickr.com/photos/carlosmontesdeocastudio)
- [Rydale Clothing](https://www.flickr.com/photos/rydaleclothing)
- [Marco Verch](https://www.flickr.com/photos/30478819@N08/48228222317/)
- [K M](https://www.flickr.com/photos/153387643@N08/49334338022/)
- [Shelby Mash](https://www.flickr.com/photos/shelbzyleigh/3809603052)
- [Rory MacLeod](https://www.flickr.com/photos/macrj/6969547134)
- [Md. Al Amin](https://www.flickr.com/photos/alamin_bd/45207044465)
- [Fatlum Haliti](https://www.flickr.com/photos/lumlumi/363449752)
- [Benny Mazur](https://www.flickr.com/photos/benimoto/399012465)
- [Sara Cooper PR](https://www.flickr.com/photos/saracooperpr/6422472677)
- [herval](https://www.flickr.com/photos/herval/2403994289)
- [Vox Efx](https://www.flickr.com/photos/vox_efx/141137669)
- [Bill Strain](https://www.flickr.com/photos/billstrain/5117042252)
- [Guilherme Yagui](https://www.flickr.com/photos/yagui7/15895161088/)
- [Deborah Austin](https://www.flickr.com/photos/littledebbie11/8703591799/)
- [We Are Social](https://www.flickr.com/photos/wearesocial/23309711462/)
- [cloud.shepherd](https://www.flickr.com/photos/exnucboy1/31017877125)
